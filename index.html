<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Super Chat</title>
    <style>
        :root { --bg: #0e1621; --header: #17212b; --msg: #182533; --my-msg: #2b5278; --text: white; --accent: #5288c1; }
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg); color: var(--text); font-family: sans-serif; }
        
        .app-container { display: flex; flex-direction: column; height: 100dvh; width: 100vw; position: relative; }

        /* –í–µ—Ä—Ö–Ω–∏–π –±–∞—Ä —Å –∫–≤–∞–¥—Ä–∞—Ç–æ–º –Ω–∞–∑–≤–∞–Ω–∏—è */
        .top-bar { height: 60px; display: flex; align-items: center; padding: 0 10px; gap: 10px; flex-shrink: 0; z-index: 10; }
        .group-box { background: var(--header); border: 2px solid var(--accent); border-radius: 8px; padding: 5px 12px; font-weight: bold; min-width: 80px; text-align: center; }

        .middle-section { display: flex; flex: 1; overflow: hidden; position: relative; }
        .chat-area { flex: 1; display: flex; flex-direction: column; overflow-y: auto; padding: 10px; gap: 10px; }
        
        /* –í—ã–¥–≤–∏–∂–Ω–∞—è –ø–∞–Ω–µ–ª—å */
        .side-panel { 
            position: absolute; right: 0; top: 0; bottom: 0; width: 75px; 
            background: var(--header); border-left: 2px solid var(--accent);
            display: flex; flex-direction: column; align-items: center; padding: 10px 0;
            transform: translateX(100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 20;
        }
        .side-panel.open { transform: translateX(0); }
        
        .users-scroll { flex: 1; display: flex; flex-direction: column; gap: 12px; overflow-y: auto; align-items: center; width: 100%; }
        .user-avatar { width: 44px; height: 44px; border-radius: 50%; background: var(--accent); background-size: cover; display: flex; align-items: center; justify-content: center; font-weight: bold; position: relative; border: 1px solid rgba(255,255,255,0.2); }
        .status-dot { position: absolute; bottom: 2px; right: 2px; width: 10px; height: 10px; border-radius: 50%; border: 2px solid var(--header); }

        /* –ù–ò–ñ–ù–ò–ï –ë–õ–û–ö–ò (–¢–í–û–ô –ß–ï–†–¢–ï–ñ) */
        .bottom-controls { display: flex; align-items: flex-end; padding: 10px; gap: 10px; background: var(--bg); }
        
        .media-square { 
            display: flex; flex-direction: column; gap: 10px; background: var(--header); 
            border: 2px solid var(--accent); border-radius: 12px; padding: 8px; width: 45px; align-items: center;
        }
        
        .input-square { 
            flex: 1; display: flex; align-items: center; background: var(--header); 
            border: 2px solid var(--accent); border-radius: 12px; padding: 5px 12px; min-height: 48px;
        }
        .input-field { flex: 1; background: none; border: none; color: white; outline: none; font-size: 16px; padding: 5px 0; }

        .icon-btn { background: none; border: none; font-size: 24px; color: var(--accent); cursor: pointer; padding: 0; }

        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        .msg-bubble { background: var(--msg); padding: 10px; border-radius: 12px; max-width: 80%; align-self: flex-start; word-wrap: break-word; }
        .my-msg { align-self: flex-end; background: var(--my-msg); }

        /* –ú–æ–¥–∞–ª–∫–∏ (–ó–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω) */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 100; align-items: center; justify-content: center; }
        .modal-content { background: var(--header); padding: 20px; border-radius: 20px; width: 280px; display: flex; flex-direction: column; gap: 12px; border: 1px solid var(--accent); }
        .modal-btn { padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; color: white; width: 100%; }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="top-bar">
            <div class="group-box" id="display-group-name">–®–∫–æ–ª–∞</div>
            <div id="typing-info" style="font-size: 10px; color: #4caf50; flex: 1;"></div>
            <button onclick="togglePanel()" class="icon-btn" id="arrow-btn">‚ûî</button>
        </div>

        <div class="middle-section">
            <div id="chat-box" class="chat-area"></div>
            
            <div id="side-panel" class="side-panel">
                <div class="users-scroll" id="users-list"></div>
                <button onclick="openSettings()" class="icon-btn" style="margin-top: 10px;">‚öôÔ∏è</button>
            </div>
        </div>

        <div class="bottom-controls">
            <div class="media-square">
                <button onclick="alert('–°–∫–æ—Ä–æ!')" class="icon-btn">üòä</button>
                <label class="icon-btn">üìé<input type="file" id="imgUpload" hidden accept="image/*"></label>
            </div>
            <div class="input-square">
                <input type="text" id="msgInput" class="input-field" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å...">
                <button id="sendBtn" class="icon-btn">‚û§</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal" onclick="this.style.display='none'">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 style="margin:0; text-align:center">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
            <button class="modal-btn" style="background:var(--accent)" onclick="location.reload()">üë§ –°–º–µ–Ω–∏—Ç—å –Ω–∏–∫</button>
            
            <div id="admin-section" style="display:none; flex-direction:column; gap:10px; border-top:1px solid #444; pt:10px;">
                <p style="font-size:12px; color:orange; margin:5px 0 0 0;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</p>
                <button class="modal-btn" style="background:#4caf50" onclick="renameGroup()">üìù –°–º–µ–Ω–∏—Ç—å –∏–º—è —á–∞—Ç–∞</button>
                <button class="modal-btn" style="background:#444" onclick="clearMessages()">üßπ –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
                <div id="user-manage-list" style="max-height:100px; overflow-y:auto; background:rgba(0,0,0,0.2); padding:5px; border-radius:5px;"></div>
            </div>

            <button class="modal-btn" style="background:#e53935" onclick="document.getElementById('settings-modal').style.display='none'">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, set, onValue, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDsDKuyifzMqmZDi6-UpvWWh7q3S_QW97E",
            authDomain: "mychat-ec2bc.firebaseapp.com",
            databaseURL: "https://mychat-ec2bc-default-rtdb.firebaseio.com",
            projectId: "mychat-ec2bc",
            storageBucket: "mychat-ec2bc.appspot.com",
            appId: "1:362129948002:web:a4b757a5e5ed0a0013803b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let myName = localStorage.getItem('chatName') || prompt("–¢–≤–æ–π –Ω–∏–∫:") || "–ì–æ—Å—Ç—å";
        localStorage.setItem('chatName', myName);

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∞–¥–º–∏–Ω–∞ (–®—É–º–∫–∞—Ä)
        if (myName.toLowerCase() === "—à—É–º–∫–∞—Ä") {
            document.getElementById('admin-section').style.display = 'flex';
        }

        window.togglePanel = () => {
            const p = document.getElementById('side-panel');
            const b = document.getElementById('arrow-btn');
            p.classList.toggle('open');
            b.innerText = p.classList.contains('open') ? '‚ûî' : '‚ûî';
            b.style.transform = p.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0deg)';
        };

        window.openSettings = () => {
            document.getElementById('settings-modal').style.display = 'flex';
            if(myName.toLowerCase() === "—à—É–º–∫–∞—Ä") loadUsersForAdmin();
        };

        // –õ–æ–≥–∏–∫–∞ —á–∞—Ç–∞
        const chatRef = ref(db, 'messages');
        const input = document.getElementById('msgInput');

        document.getElementById('sendBtn').onclick = () => {
            if (input.value.trim()) {
                push(chatRef, { name: myName, text: input.value, time: serverTimestamp() });
                input.value = "";
            }
        };

        onChildAdded(chatRef, (snap) => {
            const d = snap.val();
            const div = document.createElement('div');
            div.className = `msg-bubble ${d.name === myName ? 'my-msg' : ''}`;
            div.innerHTML = `<small style="color:var(--accent); font-weight:bold;">${d.name}</small><div>${d.text}</div>`;
            document.getElementById('chat-box').appendChild(div);
            document.getElementById('chat-box').scrollTop = document.getElementById('chat-box').scrollHeight;
        });

        // –°—Ç–∞—Ç—É—Å—ã –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
        onValue(ref(db, 'status'), (snap) => {
            const list = document.getElementById('users-list');
            list.innerHTML = "";
            snap.forEach(u => {
                const isOnline = u.val().online;
                list.innerHTML += `<div class="user-avatar">${u.key[0]}<div class="status-dot" style="background:${isOnline ? '#4caf50' : '#f44336'}"></div></div>`;
            });
        });

        // –ê–î–ú–ò–ù –§–£–ù–ö–¶–ò–ò
        window.renameGroup = () => {
            let n = prompt("–ù–æ–≤–æ–µ –∏–º—è —á–∞—Ç–∞:");
            if(n) set(ref(db, 'groupName'), n);
        };
        onValue(ref(db, 'groupName'), (s) => document.getElementById('display-group-name').innerText = s.val() || "–®–∫–æ–ª–∞");

        window.clearMessages = () => {
            if(confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è?")) set(chatRef, null);
        };

        function loadUsersForAdmin() {
            onValue(ref(db, 'status'), (snap) => {
                const container = document.getElementById('user-manage-list');
                container.innerHTML = "";
                snap.forEach(u => {
                    container.innerHTML += `<div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                        <span style="font-size:12px;">${u.key}</span>
                        <button onclick="removeUser('${u.key}')" style="background:red; color:white; border:none; border-radius:3px; font-size:10px;">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>`;
                });
            }, {onlyOnce: true});
        }
        window.removeUser = (name) => { if(confirm(`–£–¥–∞–ª–∏—Ç—å ${name}?`)) remove(ref(db, `status/${name}`)); };
    </script>
</body>
</html>

